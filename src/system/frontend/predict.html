<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="styles/predict.css" type="text/css" rel="stylesheet" />
    <link href="styles/share.css" type="text/css" rel="stylesheet" />
</head>

<body onload="drawAnimation()">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.2.1/dist/echarts.js"></script>
    <script src="https://unpkg.com/vue@next"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@0.12.0/dist/axios.min.js"></script>

    <section id="headerSection">
        <div id="inputDiv">
            <form id="steelInfoForm" @submit="checkForm" action="javascript:submitCastingPriorInfo(this)" method="post">
                <table style="border-spacing: 10px;">
                    <tr>
                        <td><span>{{steelType}}：</span></td>
                        <td><input class="boxText" id="steelTypeInput"></input></td>
                        <td><span>{{billetWidth}}：</span></td>
                        <td><input class="boxText" id="billetWidthInput"></input></td>
                        <td><span>{{billetThickness}}：</span></td>
                        <td><input class="boxText" id="billetThicknessInput"></input></td>
                        <td><input class="button text" type="submit" v-bind:value="predictButton"></input></td>

                    </tr>
                    <tr>
                        <td><span>{{castingWidth}}：</span></td>
                        <td><input class="boxText" id="castingWidthInput"></input></td>
                        <td><span>{{mode}}：</span></td>
                        <td><input class="boxText" id="modeInput"></input></td>
                        <td><span>{{targetLV}}：</span></td>
                        <td><input class="boxText" id="targetLVInput"></input></td>
                        <td><button class="button text">播放</button></td>
                    </tr>
                </table>
            </form>
            <button class="button text" style="margin: 0px 0px 0px 10px;"
                onclick="javascript:onOpenFileButtonClicked()">打开文件</button>
            <input class="button text" style="margin: 0px 0px 0px 10px; visibility: hidden;" id="openFileInput"
                type="file" onchange="javascript:onOpenFileInputChanged(this)"></input>
        </div>
    </section>
    <section id="animationSection">
        <div id="animationDiv">
            <canvas id="animationCanvas" v-bind:height="canvasHeight" v-bind:width="canvasWidth"></canvas>
        </div>
    </section>
    <section id="chartSection">
        <div id="echartDiv">

            <div v-for="(chartViewModel,index) in chartViewModels" class="echartContentDiv"
                v-show="chartViewModel.isSelected" v-bind:id="'echartContent' + chartViewModel.chartId">
            </div>
            <!-- <button id="updateButton" style="top: 35px; left: 5px; position:absolute">加入数据集</button> -->
        </div>
        <div id="tabDiv">
            <table>
                <ul id="tabRow">
                    <span style="float: right; margin: 5px;" onclick="closeTab()">❎</span>
                    <li v-for="(chartViewModel,index) in chartViewModels" @click="currentId=chartViewModel.chartId"
                        onclick="onTabClicked()" v-bind:class="{tabItemSelected:chartViewModel.isSelected}">
                        {{chartViewModel.title}}</li>
                </ul>
            </table>
        </div>
    </section>
    <!-- <section id="charSection"></section>
    <section id="mainSection">
        <div id="animationDiv"></div>
        <div id="chartDiv"></div>
    </section> -->
    <script src="src/predictView.js"></script>
    <script src="src/animationView.js"></script>
    <script src="src/lib/webgl-utils.js"></script>
    <script src="src/lib/webgl-debug.js"></script>
    <script src="src/lib/cuon-utils.js"></script>
    <script src="src/lib/cuon-matrix.js"></script>
    <script src="src/lib/utils.js"></script>
    <script type="text/javascript">
        var currentChart = null;
        function generatingCastingChart(dataViewModel) {
            var divId = createEchartContentDiv(dataViewModel.title, dataViewModel.chartId)
            var echart = echarts.init(document.getElementById(divId));
            currentChart = echart
            dataViewModel.echart = echart;
            var option = {
                xAxis: {
                    type: 'category',
                    data: dataViewModel.data.times
                },
                yAxis: {
                    type: 'value',
                    min: -2
                },
                series: [
                    {
                        data: dataViewModel.data.values,
                        type: 'line'
                    }
                ],

                toolbox: {
                    show: true,
                    feature: {
                        myTool1: { 
                            show: true,//是否显示    
                            title: '导出', //鼠标移动上去显示的文字    
                            icon: 'path://M525.4 721.2H330.9c-9 0-18.5-7.7-18.5-18.1V311c0-9 9.3-18.1 18.5-18.1h336.6c9.3 0 18.5 9.1 18.5 18.1v232.7c0 6 8.8 12.1 15 12.1 6.2 0 15-6 15-12.1V311c0-25.6-25.3-48.9-50.1-48.9h-335c-26.2 0-50.1 23.3-50.1 48.9v389.1c0 36.3 20 51.5 50.1 51.5h197.6c6.2 0 9.3-7.5 9.3-15.1 0-6-6.2-15.3-12.4-15.3zM378.8 580.6c-6.2 0-12.3 8.6-12.3 14.6s6.2 14.6 12.3 14.6h141.4c6.2 0 12.3-5.8 12.3-13.4 0.3-9.5-6.2-15.9-12.3-15.9H378.8z m251.6-91.2c0-6-6.2-14.6-12.3-14.6H375.7c-6.2 0-12.4 8.6-12.4 14.6s6.2 14.6 12.4 14.6h240.8c6.2 0.1 13.9-8.5 13.9-14.6z m-9.2-120.5H378.8c-6.2 0-12.3 8.6-12.3 14.6s6.2 14.6 12.3 14.6h240.8c7.7 0 13.9-8.6 13.9-14.6s-6.2-14.6-12.3-14.6z m119.4 376.6L709 714.1c9.2-12 14.6-27 14.6-43.2 0-39.4-32.1-71.4-71.8-71.4-39.7 0-71.8 32-71.8 71.4s32.1 71.4 71.8 71.4c16.3 0 31.3-5.4 43.4-14.5l31.6 31.5c3.8 3.8 10 3.8 13.8 0 3.8-3.8 3.8-10 0-13.8z m-88.8-23.6c-28.3 0-51.3-22.8-51.3-51s23-51 51.3-51c28.3 0 51.3 22.8 51.3 51s-23 51-51.3 51z', //图标    
                            onclick: function () {//点击事件,这里的option1是chart的option信息    
                                exportToCsv();
                            }
                        },
                        mark: { show: true },
                        dataView: {
                            show: true,
                            readOnly: false,
                            //修改数据视图格式
                            optionToContent: function (opt) {
                                console.log("fskdjflsd")
                            }
                        },
                        magicType: { show: true, type: ['line', 'bar'] },
                        restore: { show: true },
                        saveAsImage: { show: true },
                        dataZoom: {
                            show: true,
                        },
                    }
                }
            };

            echart.setOption(option)

            //_animationStarted = true;
        }

        function createEchartContentDiv(name, chartId) {
            var divId = "echartContent" + chartId;
            // Create tab page
            //var echartDiv = document.getElementById("echartDiv");
            //echartDiv.innerHTML = "<div class=\"echartContentDiv\" id=\""+divId+"\"></div>";
            return divId;
        }

        window.onresize = function () {
            resizeEverything();
        }

        function onOpenFileButtonClicked() {
            var openFileButton = document.getElementById('openFileInput');
            openFileButton.click();
        }

        function resizeEverything() {

            for (var i = 0; i < chartCollectionViewModel.chartViewModels.length; ++i) {
                if (chartCollectionViewModel.chartViewModels[i].chartId == chartCollectionViewModel.currentId) {
                    if (chartCollectionViewModel.chartViewModels[i].echart != null) {
                        chartCollectionViewModel.chartViewModels[i].echart.resize();
                    }
                    break;
                }
            }

            var canvas = document.getElementById('animationCanvas');
            var canvasDiv = document.getElementById('animationDiv');
            // canvas.Height = canvasDiv.Height;
            //startAnimation()

            canvas.height = canvasDiv.clientHeight;
            canvas.width = canvasDiv.clientWidth;
        }

        function onOpenFileInputChanged(event) {
            var openFileInput = document.getElementById('openFileInput');
            var filePath = openFileInput.value;
            var filePaths = filePath.split('\\');
            var fileName = filePaths[filePaths.length - 1]
            const formData = new FormData();
            formData.append("file", event.files[0]);
            axios.post('http://localhost:8080/openCastingCurveFile', formData, {
                headers: {
                    'Content-Type': 'multipart/form-data',
                    Accept: "application/json"
                }
            }).then(response => {
                if (chartCollectionViewModel.isEmpty) {
                    chartCollectionViewModel.chartViewModels.splice(0, 1);
                    chartCollectionViewModel.isEmpty = false;
                }
                vmId = hashCode(fileName, seedCounter++);

                showCastingCurve(response.data, fileName, vmId);
            }).then().catch(
                err => console.log(err))

        }

        function closeTab() {
            var i = 0;
            var length = chartCollectionViewModel.chartViewModels.length;

            for (i = 0; i < length; ++i) {
                if (chartCollectionViewModel.chartViewModels[i].chartId == chartCollectionViewModel.currentId) {
                    var element = chartCollectionViewModel.chartViewModels[i];

                    if (element.echart != null) {
                        element.echart.clear();
                        element.echart.dispose();
                    }

                    chartCollectionViewModel.chartViewModels.splice(i, 1);
                    break;
                }
            }

            if (length == 1) {
                chartCollectionViewModel.chartViewModels.push(defaultChartViewModel);
                chartCollectionViewModel.isEmpty = true;
            }
            else if (length == i + 1) {
                selectItem(chartCollectionViewModel.chartViewModels[i - 1].chartId);
            }
            else {
                selectItem(chartCollectionViewModel.chartViewModels[i].chartId);
            }
        }
    </script>
</body>

</html>